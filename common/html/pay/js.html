<script type="text/javascript">
    $(function () {
        $('.pay_action').click(function () {
            var pay_id = $(this).attr("data-pay-id")
            var goods_id = $(this).attr("data-goods-id")
            $.getJSON("/pay", {"pay_id": pay_id, "goods_id": goods_id}, function (data) {
                console.log(data)
                if (data.pay_url) {
                    window.open(data.pay_url, "_blank", 'width=600,height=600');
                    setTimeout(function () {
                        window.location = "/pay_" + pay_id + "_" + goods_id + ".html"
                    }, 1000)
                } else {
                    alert("无法获取有效支付通道，请稍后再试")
                }
            })
        });
        $("#check_btn").click(function () {
            var check_btn = $(this);
            if (window.check_pay) {
                return
            }
            window.check_pay = true;
            var old_val = check_btn.text()
            check_btn.text("正在检查支付状态...")
            $.getJSON("/pay_check", {"pay_id": "{{ pay_id }}", "goods_id": "{{goods_id}}"}, function (data) {
                if (data.errno === 0) {
                    check_btn.val("支付已完成，正在跳转到VIP中心")
                    window.location = "/user.html"
                } else {
                    check_btn.text(old_val)
                    alert(data.msg + "，请完成支付后再点击本按钮检查")
                }
                window.check_pay = false;
            })
        });
    });
</script>